---
phase: 03-library-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/transcripts.ts
  - convex/tags.ts
  - convex/deepgram.ts
autonomous: true

must_haves:
  truths:
    - "Transcripts table has isStarred and fullText fields with search indexes on title and fullText"
    - "Tags and transcriptTags tables exist with proper indexes"
    - "Star toggle mutation flips isStarred boolean on a transcript"
    - "Search query returns transcripts matching by title or content"
    - "Tag CRUD operations work: create tag, add tag to transcript, remove tag, list tags"
    - "completeTranscript denormalizes fullText from words table"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Extended schema with isStarred, fullText, search indexes, tags + transcriptTags tables"
      contains: "searchIndex"
    - path: "convex/transcripts.ts"
      provides: "toggleStar mutation, search query"
      exports: ["toggleStar", "search"]
    - path: "convex/tags.ts"
      provides: "Tag CRUD: listUserTags, getAllTranscriptTags, addTagToTranscript, removeTagFromTranscript"
      exports: ["listUserTags", "getAllTranscriptTags", "addTagToTranscript", "removeTagFromTranscript"]
  key_links:
    - from: "convex/transcripts.ts (search)"
      to: "convex/schema.ts (search indexes)"
      via: "withSearchIndex on search_title and search_content"
      pattern: "withSearchIndex.*search_"
    - from: "convex/transcripts.ts (completeTranscript)"
      to: "convex/schema.ts (fullText field)"
      via: "concatenate words into fullText on completion"
      pattern: "fullText"
    - from: "convex/tags.ts"
      to: "convex/schema.ts (tags + transcriptTags)"
      via: "junction table queries"
      pattern: "transcriptTags"
---

<objective>
Extend the Convex backend with schema changes and queries/mutations for starring, full-text search, and tagging. This is the data foundation that all Phase 3 UI plans depend on.

Purpose: All library features (search, filter, star, tags) require backend data support before UI can be built.
Output: Extended schema with search indexes, star/search/tag queries and mutations, fullText denormalization.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-library-organization/03-CONTEXT.md
@.planning/phases/03-library-organization/03-RESEARCH.md
@convex/schema.ts
@convex/transcripts.ts
@convex/deepgram.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema with isStarred, fullText, search indexes, tags tables</name>
  <files>convex/schema.ts</files>
  <action>
Extend the existing Convex schema with the following additions:

**transcripts table additions:**
- `isStarred: v.optional(v.boolean())` — defaults to undefined (falsy)
- `fullText: v.optional(v.string())` — denormalized concatenated transcript text for search
- Add search index: `.searchIndex("search_title", { searchField: "title", filterFields: ["userId"] })`
- Add search index: `.searchIndex("search_content", { searchField: "fullText", filterFields: ["userId"] })`

**New tags table:**
```
tags: defineTable({
  userId: v.id("users"),
  name: v.string(),
})
  .index("by_userId", ["userId"])
  .index("by_userId_name", ["userId", "name"])
```

**New transcriptTags junction table:**
```
transcriptTags: defineTable({
  transcriptId: v.id("transcripts"),
  tagId: v.id("tags"),
})
  .index("by_transcript", ["transcriptId"])
  .index("by_tag", ["tagId"])
```

Keep all existing table definitions and fields intact. Only ADD new fields and tables.
  </action>
  <verify>Run `npx convex dev --once` (or check that `npx convex dev` running in background accepts the schema push). Schema should deploy without errors.</verify>
  <done>Schema has isStarred + fullText on transcripts, search indexes on title and fullText, and tags + transcriptTags tables with indexes.</done>
</task>

<task type="auto">
  <name>Task 2: Add star, search, tag mutations/queries, and fullText denormalization</name>
  <files>convex/transcripts.ts, convex/tags.ts, convex/deepgram.ts</files>
  <action>
**In convex/transcripts.ts, add:**

1. `toggleStar` mutation:
   - Args: `{ transcriptId: v.id("transcripts") }`
   - Auth check, verify ownership
   - Flip `isStarred`: `await ctx.db.patch(args.transcriptId, { isStarred: !transcript.isStarred })`

2. `search` query:
   - Args: `{ searchTerm: v.string() }`
   - Auth check, get userId
   - Search title index: `ctx.db.query("transcripts").withSearchIndex("search_title", q => q.search("title", args.searchTerm).eq("userId", userId)).take(25)`
   - Search content index: `ctx.db.query("transcripts").withSearchIndex("search_content", q => q.search("fullText", args.searchTerm).eq("userId", userId)).take(25)`
   - Merge and deduplicate (title matches first), return merged array
   - IMPORTANT: Convex requires non-empty search term — the client will use "skip" for empty queries

3. Update `completeTranscript` internal mutation:
   - After patching status/duration, also fetch all words for the transcript, concatenate their text with spaces, and patch `fullText` on the transcript
   - This denormalizes the transcript text at completion time for search

4. Update `complete` mutation (same pattern):
   - After patching status/duration, fetch all words and patch `fullText`

**Create convex/tags.ts with:**

1. `listUserTags` query:
   - No args, auth check
   - Return all tags for the current user: `ctx.db.query("tags").withIndex("by_userId", q => q.eq("userId", userId)).collect()`

2. `getAllTranscriptTags` query:
   - No args, auth check
   - Fetch all user's tags, then for each tag fetch its transcriptTag links via `by_tag` index
   - Return array of `{ transcriptId, tagName }` objects for efficient client-side lookup

3. `addTagToTranscript` mutation:
   - Args: `{ transcriptId: v.id("transcripts"), tagName: v.string() }`
   - Auth check, verify transcript ownership
   - Find-or-create tag by name+userId using `by_userId_name` index
   - Check existing link via `by_transcript` index + filter by tagId
   - Insert into transcriptTags if not already linked
   - Enforce limit: count existing tags for this transcript, reject if >= 8

4. `removeTagFromTranscript` mutation:
   - Args: `{ transcriptId: v.id("transcripts"), tagId: v.id("tags") }`
   - Auth check, verify transcript ownership
   - Find and delete the transcriptTags link

5. `getTranscriptTags` query:
   - Args: `{ transcriptId: v.id("transcripts") }`
   - Auth check, verify transcript ownership
   - Fetch all transcriptTag links for this transcript via `by_transcript` index
   - For each link, fetch the tag name from the tags table
   - Return array of `{ tagId, tagName }` objects

Import `auth` from `"./auth"` in tags.ts, same pattern as transcripts.ts.

**In convex/deepgram.ts:**
- No changes needed — `transcribeFile` already calls `internal.transcripts.completeTranscript` which will now handle fullText.
  </action>
  <verify>
Run `npx convex dev --once` to verify all new functions compile and deploy. Check that the Convex dashboard shows the new functions: `transcripts.toggleStar`, `transcripts.search`, `tags.listUserTags`, `tags.getAllTranscriptTags`, `tags.addTagToTranscript`, `tags.removeTagFromTranscript`, `tags.getTranscriptTags`.
  </verify>
  <done>
Star toggle flips isStarred, search returns merged title+content results, tag CRUD works with junction table, completeTranscript denormalizes fullText from words. All Convex functions deploy without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds with no errors
2. Schema has search indexes visible in Convex dashboard
3. New functions are listed in Convex dashboard under transcripts and tags modules
4. No existing functionality broken (list, get, create, complete, appendWords, etc. still work)
</verification>

<success_criteria>
- Schema deployed with isStarred, fullText, search_title index, search_content index, tags table, transcriptTags table
- toggleStar, search, tag CRUD functions all deploy successfully
- completeTranscript and complete mutations denormalize fullText from words
- All existing Convex functions continue to work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-library-organization/03-01-SUMMARY.md`
</output>
