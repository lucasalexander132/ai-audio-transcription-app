---
phase: 03-library-organization
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(app)/transcripts/[id]/page.tsx
  - app/components/library/tag-picker-modal.tsx
  - app/components/library/tag-chips.tsx
  - app/components/export/export-menu.tsx
  - app/components/export/transcript-exporter.ts
autonomous: true

must_haves:
  truths:
    - "User can tap 3-dot overflow menu on transcript detail page and see Export PDF / Export TXT options"
    - "PDF export generates styled document with title header, metadata, speaker names bolded, timestamps in gray"
    - "TXT export generates clean plain text with title underlined, [timestamp] Speaker: format"
    - "File naming follows date + title pattern (e.g., '2026-02-10 Team Standup.pdf')"
    - "iOS Safari uses Web Share API for export, desktop uses direct download"
    - "User can open tag picker modal from transcript detail page"
    - "User can add existing tags or create new tags from the tag picker"
    - "User can remove tags from a transcript"
    - "Tags display as chips on the transcript detail page"
  artifacts:
    - path: "app/components/export/export-menu.tsx"
      provides: "3-dot overflow menu with Export PDF and Export TXT options"
      exports: ["ExportMenu"]
    - path: "app/components/export/transcript-exporter.ts"
      provides: "Pure functions for PDF and TXT generation"
      exports: ["exportTranscriptAsPDF", "exportTranscriptAsTXT"]
    - path: "app/components/library/tag-picker-modal.tsx"
      provides: "Modal for selecting/creating tags"
      exports: ["TagPickerModal"]
    - path: "app/components/library/tag-chips.tsx"
      provides: "Tag chip display with optional remove button"
      exports: ["TagChips"]
    - path: "app/(app)/transcripts/[id]/page.tsx"
      provides: "Detail page with export menu + tag section"
  key_links:
    - from: "app/components/export/transcript-exporter.ts"
      to: "jspdf"
      via: "dynamic import() for lazy loading"
      pattern: "import.*jspdf"
    - from: "app/components/export/export-menu.tsx"
      to: "app/components/export/transcript-exporter.ts"
      via: "calls export functions on menu item click"
      pattern: "exportTranscriptAs"
    - from: "app/components/library/tag-picker-modal.tsx"
      to: "convex/tags.ts"
      via: "useMutation for addTagToTranscript, useQuery for listUserTags"
      pattern: "api\\.tags"
---

<objective>
Add transcript export (PDF/TXT) via overflow menu and tag management (picker modal + chips) to the transcript detail page. These are the detail-page counterparts to the library page features.

Purpose: Users need to export transcripts for sharing/archiving and tag them for organization.
Output: Export menu with styled PDF/TXT generation, tag picker modal, tag chips on detail page.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-library-organization/03-CONTEXT.md
@.planning/phases/03-library-organization/03-RESEARCH.md
@.planning/phases/03-library-organization/03-01-SUMMARY.md
@app/(app)/transcripts/[id]/page.tsx
@convex/transcripts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export functions and export menu component</name>
  <files>app/components/export/transcript-exporter.ts, app/components/export/export-menu.tsx</files>
  <action>
**First, install jsPDF:**
```bash
npm install jspdf
```

**Create `app/components/export/transcript-exporter.ts`:**
Pure functions (no React), "use client" is NOT needed here since it's just utility.

1. `exportTranscriptAsPDF(params)` function:
   - Params: `{ title: string; date: string; duration: string; speakers: string[]; tags: string[]; segments: { speaker: string; timestamp: string; text: string }[] }`
   - Lazy-load jsPDF: `const { jsPDF } = await import("jspdf")`
   - Create A4 document, track Y position starting at 20
   - **Title:** Helvetica bold, 18pt, color `#1A1A1A`
   - **Metadata line:** Helvetica normal, 10pt, color `#8B7E74` — "date | duration | N speakers"
   - **Tags line** (if any): "Tags: tag1, tag2, ..." in same style
   - **Divider:** horizontal line in `#EDE6DD`
   - **Transcript segments:** For each segment:
     - Check page break: if `y > 270`, call `doc.addPage()` and reset `y = 20`
     - Speaker name: Helvetica bold, 11pt, `#1A1A1A`
     - Timestamp: Helvetica normal, 9pt, `#B5A99A`, on same line after speaker
     - Text: Helvetica normal, 10pt, `#1A1A1A`, use `doc.splitTextToSize(text, 170)` for wrapping
     - Advance Y by `lines.length * 5 + 6`
   - **File naming:** `YYYY-MM-DD Title.pdf` — sanitize title (remove non-alphanumeric except spaces)
   - Return the blob instead of auto-saving, to support both download and share
   - Create blob: `doc.output("blob")`

2. `exportTranscriptAsTXT(params)` function:
   - Same params structure as PDF
   - Format: title, `=` underline, blank line, Date/Duration/Tags metadata, `---` divider, blank line
   - Each segment: `[timestamp] Speaker:\ntext\n`
   - Return string content

3. `downloadFile(blob: Blob, filename: string)` async function:
   - Try Web Share API first: `navigator.canShare?.({ files: [new File([blob], filename)] })`
   - If canShare: `navigator.share({ files: [new File([blob], filename, { type: blob.type })], title: filename })`
   - Catch AbortError (user cancelled) silently
   - Fallback: create `<a>` element with `URL.createObjectURL`, click, cleanup

**Create `app/components/export/export-menu.tsx`:**
- "use client" component
- Props: `{ title: string; date: string; duration: string; speakers: string[]; tags: string[]; segments: { speaker: string; timestamp: string; text: string }[] }`
- Render a 3-dot icon button (vertical dots, matching existing style)
- On click: toggle a dropdown menu positioned absolutely below the button
- Menu items: "Export as PDF" with document icon, "Export as TXT" with text icon
- On "Export as PDF": call `exportTranscriptAsPDF(props)` then `downloadFile(blob, filename)`
- On "Export as TXT": call `exportTranscriptAsTXT(props)` then create Blob and `downloadFile`
- Dropdown style: white bg, `#EDE6DD` border, rounded-xl, shadow-lg, z-50
- Click outside closes dropdown (useEffect with document click listener)
- Menu item style: padding 12px 16px, hover bg `#FBF5EE`, fontSize 14, color `#1A1A1A`
  </action>
  <verify>Files exist. `npm run build` succeeds (jsPDF installed and imported correctly via dynamic import). Export functions return proper blob/string outputs.</verify>
  <done>Export menu renders 3-dot button with PDF/TXT dropdown, calls export functions that generate styled documents with proper formatting, and uses Web Share API with download fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Create tag picker modal and tag chips, wire into transcript detail page</name>
  <files>app/components/library/tag-picker-modal.tsx, app/components/library/tag-chips.tsx, app/(app)/transcripts/[id]/page.tsx</files>
  <action>
**Create `app/components/library/tag-chips.tsx`:**
- "use client" component
- Props: `{ tags: { tagId: string; tagName: string }[]; onRemove?: (tagId: string) => void; maxDisplay?: number }`
- Render tags as horizontal flex-wrap chips
- Chip style: `backgroundColor: "#F5EDE4"`, `color: "#8B7E74"`, rounded-full, padding `4px 10px`, fontSize 11
- If `onRemove` provided: show small X button on each chip
- If tags.length > maxDisplay (default 5): show "+N more" chip
- If no tags: render nothing (return null)

**Create `app/components/library/tag-picker-modal.tsx`:**
- "use client" component
- Props: `{ transcriptId: Id<"transcripts">; currentTags: { tagId: string; tagName: string }[]; isOpen: boolean; onClose: () => void }`
- Modal overlay: fixed inset-0, bg black/50 opacity, z-50
- Modal body: bottom sheet style (position fixed, bottom 0, left 0, right 0), white bg, rounded-t-2xl, max-height 60vh
- Header: "Add Tags" title + X close button
- Text input for creating new tag: "Enter tag name..." placeholder
  - On Enter: call `addTagToTranscript` mutation, clear input
  - Validate: non-empty, trimmed, not duplicate
- Existing tags list: `useQuery(api.tags.listUserTags)` — show all user's tags
  - Each tag: show name with checkmark if already on this transcript, tap to toggle
  - If tag is on transcript: call `removeTagFromTranscript` on tap
  - If tag is NOT on transcript: call `addTagToTranscript` on tap
- Style tags list items: padding 12px 16px, border-bottom `#EDE6DD`, fontSize 14
- Use `useMutation(api.tags.addTagToTranscript)` and `useMutation(api.tags.removeTagFromTranscript)`

**Modify `app/(app)/transcripts/[id]/page.tsx`:**

In the `TranscriptDetailContent` component:

1. Add data fetching:
   - `const transcriptTags = useQuery(api.tags.getTranscriptTags, { transcriptId })`
   - `const speakerLabels = useQuery(api.transcripts.getSpeakerLabels, { transcriptId })`
   - `const words = useQuery(api.transcripts.getWords, { transcriptId })`

2. Add state:
   - `const [showTagPicker, setShowTagPicker] = useState(false)`

3. Add ExportMenu in the header area (next to the back button or in a top-right position):
   - Build segments array from words + speakerLabels for export:
     - Group consecutive words by speaker into segments
     - Format timestamp as MM:SS from startTime
     - Use speaker label from speakerLabels or fallback "Speaker N"
   - Build speakers array from unique speaker labels
   - Build tags array from transcriptTags
   - Pass all props to ExportMenu

4. Add tag section below metadata row:
   - TagChips component showing current tags (with remove capability)
   - "Add Tag" button: pill shape, `#F5EDE4` bg, `+` icon, opens tag picker modal
   - TagPickerModal (conditionally rendered when showTagPicker is true)

5. Import the new components at the top of the file

Note: The existing page already has `words` query in the parent component but not in `TranscriptDetailContent`. Add the necessary queries inside `TranscriptDetailContent` since that's where the completed transcript renders.
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Navigate to a transcript detail page: export menu appears with 3-dot icon, tag section shows below metadata, tag picker modal opens on "Add Tag" tap.
  </verify>
  <done>
Transcript detail page has: (1) 3-dot export menu with PDF/TXT options that generate properly formatted files, (2) tag chips display with remove buttons, (3) tag picker modal for adding/creating tags, (4) all wired to Convex mutations/queries.
  </done>
</task>

</tasks>

<verification>
1. Export menu appears on transcript detail page, PDF export generates styled document
2. TXT export generates clean formatted text
3. On iOS Safari (or mobile), Web Share API is used; on desktop, file downloads directly
4. Tag picker modal opens, shows existing tags with toggle, allows creating new tags
5. Tags appear as chips on the detail page, removable via X button
6. Tag limit of 8 enforced (backend rejects if exceeded)
7. No regressions on transcript detail view (audio player, transcript view, speaker labels still work)
</verification>

<success_criteria>
- User can export transcript as styled PDF with bolded speakers, gray timestamps, proper page breaks
- User can export transcript as formatted TXT
- File naming follows "YYYY-MM-DD Title" pattern
- User can add/remove tags via modal picker
- Tag chips display on transcript detail page
- Export and tag features don't break existing detail page functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-library-organization/03-03-SUMMARY.md`
</output>
