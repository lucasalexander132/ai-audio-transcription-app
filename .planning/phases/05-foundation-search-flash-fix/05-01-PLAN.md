---
phase: 05-foundation-search-flash-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/hooks/use-stable-query.ts
  - app/(app)/transcripts/page.tsx
autonomous: true

must_haves:
  truths:
    - "Typing in the search bar never shows unfiltered results -- the list either holds the previous results or shows filtered results, with no flash of the full list"
    - "Clearing the search input returns to the normal tab-filtered view without showing stale search results"
  artifacts:
    - path: "app/lib/hooks/use-stable-query.ts"
      provides: "Convex query wrapper that holds previous results during loading"
      exports: ["useStableQuery"]
      contains: "useRef"
    - path: "app/(app)/transcripts/page.tsx"
      provides: "Flash-free search filtering"
      contains: "useStableQuery"
  key_links:
    - from: "app/(app)/transcripts/page.tsx"
      to: "app/lib/hooks/use-stable-query.ts"
      via: "import useStableQuery"
      pattern: "import.*useStableQuery.*use-stable-query"
    - from: "app/(app)/transcripts/page.tsx"
      to: "isSearchActive logic"
      via: "searchInput.length >= 2 check (not just debouncedSearch)"
      pattern: "searchInput\\.length\\s*>=\\s*2"
---

<objective>
Fix the search flash bug where typing in the search bar briefly shows the full unfiltered transcript list before search results appear.

Purpose: This is the highest-priority bug fix in v1.1. The flash occurs because Convex's useQuery returns undefined during loading transitions when query args change (debounce gap), and the current isSearchActive check falls back to unfiltered results during that undefined window.

Output: A useStableQuery hook that holds previous query results during loading, and an updated TranscriptsPage that uses input-awareness to prevent the flash from both the debounce gap and the Convex loading gap.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-foundation-search-flash-fix/05-RESEARCH.md

@app/(app)/transcripts/page.tsx
@app/lib/hooks/use-debounce.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useStableQuery hook and fix TranscriptsPage search flash</name>
  <files>
    app/lib/hooks/use-stable-query.ts
    app/(app)/transcripts/page.tsx
  </files>
  <action>
**Step 1: Create the useStableQuery hook.**

Create `app/lib/hooks/use-stable-query.ts` with the following implementation:

```typescript
"use client";

import { useRef } from "react";
import { useQuery } from "convex/react";
import type { FunctionReference, FunctionArgs, FunctionReturnType } from "convex/server";

export function useStableQuery<Query extends FunctionReference<"query">>(
  query: Query,
  args: FunctionArgs<Query> | "skip"
): FunctionReturnType<Query> | undefined {
  const result = useQuery(query, args);
  const stored = useRef(result);

  if (result !== undefined) {
    stored.current = result;
  }

  return stored.current;
}
```

This is the documented Convex pattern. When query args change, `useQuery` returns `undefined` during loading. Instead of passing that `undefined` through (which causes the flash), we hold the previous result in a `useRef` until the new result arrives.

**Step 2: Update TranscriptsPage to fix the flash.**

In `app/(app)/transcripts/page.tsx`, make these changes:

1. **Replace the search query import:** Change `import { useQuery } from "convex/react"` to also import `useStableQuery`:
   ```typescript
   import { useQuery } from "convex/react";
   import { useStableQuery } from "@/app/lib/hooks/use-stable-query";
   ```

2. **Switch the search query to useStableQuery:** Change the `searchResults` query from `useQuery` to `useStableQuery`:
   ```typescript
   const searchResults = useStableQuery(
     api.transcripts.search,
     debouncedSearch.length >= 2 ? { searchTerm: debouncedSearch } : "skip"
   );
   ```
   Keep `useQuery` for `allTranscripts`, `allTranscriptTags`, and `allSpeakerLabels` -- those don't have the flash problem since their args don't change.

3. **Fix the isSearchActive check to be input-aware:** Replace the current `isSearchActive` logic:
   ```typescript
   // OLD (causes flash during debounce gap):
   // const isSearchActive = debouncedSearch.length >= 2 && searchResults !== undefined;

   // NEW (input-aware -- prevents flash):
   const isSearchActive = searchInput.length >= 2;
   ```
   This is the critical fix. By using `searchInput` (immediate) instead of `debouncedSearch` (delayed), we enter "search mode" the moment the user types 2+ characters. During the debounce gap, `useStableQuery` holds the previous results (or `undefined` if this is the first search). The display logic already handles `searchResults` being undefined via the `?? []` fallback.

4. **Handle the "first search" edge case:** The `displayTranscripts` memo currently checks `isSearchActive` to decide between filtered and search results. With the new input-aware `isSearchActive`, the first time the user types (before any search results arrive), `searchResults` will be `undefined` (useStableQuery has nothing stored yet). The existing code already handles this via `const backendResults = searchResults ?? []` which returns an empty array -- this is correct behavior (shows "0 search results" briefly, then populates when results arrive). This is much better than flashing the full unfiltered list.

**What NOT to change:**
- Do NOT change the 300ms debounce delay -- it's appropriate
- Do NOT change the `>= 2` character minimum for search -- it's appropriate
- Do NOT change how `allTranscripts` is fetched -- it doesn't need useStableQuery
- Do NOT change the `displayTranscripts` memo logic beyond the `isSearchActive` reference -- the tag-matching logic is correct
  </action>
  <verify>
1. Run `npx tsc --noEmit` to confirm no TypeScript errors
2. Run `npm run build` to confirm the build succeeds
3. Start dev server with `npm run dev` and manually test:
   - Navigate to /transcripts
   - Open search, type a query quickly -- the list should NOT flash to show all transcripts
   - Clear the search -- should return to normal tab-filtered view (not stale search results)
   - Type a 1-character query -- should stay in tab-filtered mode (minimum 2 chars)
  </verify>
  <done>
- `use-stable-query.ts` exists and exports `useStableQuery`
- `TranscriptsPage` imports and uses `useStableQuery` for the search query
- `isSearchActive` uses `searchInput.length >= 2` (input-aware, not debounce-dependent)
- Typing in search never shows the full unfiltered list -- the flash bug is fixed
- Clearing search returns to normal tab-filtered transcripts
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. Search flash bug is eliminated -- no unfiltered results visible when typing
</verification>

<success_criteria>
- The search flash bug is fixed: typing in the search bar never shows unfiltered results
- Clearing the search returns to normal tab-filtered view without stale results
- useStableQuery hook is reusable for other Convex queries in future phases
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-search-flash-fix/05-01-SUMMARY.md`
</output>
