---
phase: 02-file-upload-batch-processing
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/lib/hooks/use-file-upload.ts
  - app/components/audio/file-upload.tsx
  - app/(app)/record/page.tsx
  - app/(app)/transcripts/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can select an audio file (MP3, WAV, M4A, WebM) from device storage via file picker"
    - "User sees upload progress percentage while file uploads"
    - "User sees clear error message if file is too large (>100MB) or wrong format"
    - "User is navigated to transcript detail page after upload completes"
    - "Transcript detail page shows processing spinner while transcription is in progress"
    - "Uploaded file transcripts appear in the same list as live recordings"
  artifacts:
    - path: "app/lib/hooks/use-file-upload.ts"
      provides: "useFileUpload hook with validation, upload progress, and transcription trigger"
      exports: ["useFileUpload"]
    - path: "app/components/audio/file-upload.tsx"
      provides: "FileUpload component with file picker, progress bar, and error display"
      exports: ["FileUpload"]
    - path: "app/(app)/record/page.tsx"
      provides: "Record page with Microphone/Upload File tab switching"
      contains: "FileUpload"
    - path: "app/(app)/transcripts/[id]/page.tsx"
      provides: "Transcript detail page with processing state handler"
      contains: "processing"
  key_links:
    - from: "app/lib/hooks/use-file-upload.ts"
      to: "convex/transcripts.ts"
      via: "useMutation(api.transcripts.createFromUpload)"
      pattern: "api\\.transcripts\\.createFromUpload"
    - from: "app/lib/hooks/use-file-upload.ts"
      to: "convex/deepgram.ts"
      via: "useAction(api.deepgram.transcribeFile)"
      pattern: "api\\.deepgram\\.transcribeFile"
    - from: "app/lib/hooks/use-file-upload.ts"
      to: "convex/recordings.ts"
      via: "useMutation(api.recordings.generateUploadUrl) + useMutation(api.recordings.saveRecording)"
      pattern: "api\\.recordings\\.(generateUploadUrl|saveRecording)"
    - from: "app/(app)/record/page.tsx"
      to: "app/components/audio/file-upload.tsx"
      via: "Import and render FileUpload component"
      pattern: "FileUpload"
---

<objective>
Build the file upload frontend: a file picker component with client-side validation, upload progress tracking via XMLHttpRequest, and integration into the record page with Microphone/Upload tab switching. Add processing state display to the transcript detail page so users see a spinner while their uploaded file is being transcribed.

Purpose: Complete the user-facing file upload flow so users can select, upload, and get transcriptions of pre-recorded audio files.
Output: Working file upload UI integrated into the record page, with processing indicator in transcript detail view.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-file-upload-batch-processing/02-RESEARCH.md
@.planning/phases/02-file-upload-batch-processing/02-01-SUMMARY.md

@convex/schema.ts
@convex/deepgram.ts
@convex/transcripts.ts
@convex/recordings.ts
@app/(app)/record/page.tsx
@app/(app)/transcripts/[id]/page.tsx
@app/lib/stores/recording-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file upload hook and component</name>
  <files>app/lib/hooks/use-file-upload.ts, app/components/audio/file-upload.tsx</files>
  <action>
  **Create `app/lib/hooks/use-file-upload.ts`:**

  A custom React hook that manages the entire file upload flow:

  1. **State:** `status` (idle | validating | uploading | processing | complete | error), `progress` (0-100), `error` (string | null)

  2. **Convex hooks:**
     - `useMutation(api.transcripts.createFromUpload)` — creates transcript record
     - `useMutation(api.recordings.generateUploadUrl)` — gets upload URL
     - `useMutation(api.recordings.saveRecording)` — saves recording metadata
     - `useAction(api.deepgram.transcribeFile)` — triggers server-side transcription

  3. **File validation function** (not exported, internal helper):
     - Accepted MIME types: `audio/mpeg`, `audio/mp3`, `audio/wav`, `audio/x-wav`, `audio/wave`, `audio/mp4`, `audio/x-m4a`, `audio/m4a`, `audio/webm`, `audio/ogg`
     - Extension fallback: if MIME type not recognized, check file extension (.mp3, .wav, .m4a, .webm, .ogg)
     - Max file size: 100MB (100 * 1024 * 1024)
     - Min file size: 1024 bytes (reject empty/corrupted)
     - Return null if valid, error string if invalid

  4. **Upload with progress function** (internal helper):
     - Use `XMLHttpRequest` (NOT fetch) for upload progress tracking
     - POST to the upload URL with Content-Type set to file.type
     - Track `xhr.upload.onprogress` events, calculate percentage
     - Parse response JSON to get `storageId`
     - Return Promise<{ storageId: string }>

  5. **`uploadFile(file: File)` callback:**
     - Set status to "validating", run validation. On failure: set error + status "error", return null
     - Create transcript via `createFromUpload({ title: file.name.replace(/\.[^.]+$/, "") })`
     - Set status to "uploading", generate upload URL, upload file with progress tracking
     - Save recording via `saveRecording({ transcriptId, storageId, format: file.type || "audio/mpeg", size: file.size })`
     - Set status to "processing"
     - Fire transcribeFile action (fire-and-forget with .catch for error logging — Convex subscriptions handle status updates)
     - Return transcriptId on success
     - Wrap everything in try/catch, set error on failure

  6. **`reset()` callback:** Reset status to "idle", progress to 0, error to null

  Return: `{ status, progress, error, uploadFile, reset }`

  **Create `app/components/audio/file-upload.tsx`:**

  A "use client" component that provides the file upload UI:

  1. **Hidden file input** with ref. Accept attribute: `"audio/mpeg,.mp3,audio/wav,audio/x-wav,audio/wave,.wav,audio/mp4,audio/x-m4a,.m4a,audio/webm,.webm"`
  2. **Idle state:** Show a large tappable upload area with dashed border, upload icon, "Select Audio File" text, and supported formats listed below ("MP3, WAV, M4A, WebM — Max 100MB"). Clicking triggers file input. Use project color palette: cream background (#FFF9F0), dashed border (#D2B48C), text (#8B7E74).
  3. **Uploading state:** Show filename, upload progress bar (percentage), and a cancel hint. Progress bar uses burnt sienna (#D4622B) fill on cream (#EDE6DD) background track. Show percentage text.
  4. **Processing state:** Show spinner (CSS animation, spinning circle with burnt sienna border-top on cream border), "Transcribing your file..." text, "This usually takes a few seconds" subtext.
  5. **Error state:** Show error message in warm red on light orange background (#FFF0E6 bg, #E53E3E text), with "Try Again" button that calls reset().
  6. **On file select:** Call uploadFile(file). On success (transcriptId returned), call router.push(`/transcripts/${transcriptId}`). Reset file input value after selection so same file can be re-selected.

  Style consistently with existing app: cream backgrounds, rounded corners (borderRadius 16-20), warm color palette, font sizes matching existing components (13-14px body, 16px emphasis).
  </action>
  <verify>
  1. Files exist: `app/lib/hooks/use-file-upload.ts` and `app/components/audio/file-upload.tsx`
  2. TypeScript compiles: `npx tsc --noEmit` passes (or at least these files have no type errors)
  3. Imports resolve correctly (api.transcripts.createFromUpload, api.deepgram.transcribeFile, etc.)
  </verify>
  <done>
  - useFileUpload hook handles validation, upload with XHR progress, and transcription trigger
  - FileUpload component shows appropriate UI for each status (idle, uploading, processing, error)
  - Client-side validation rejects files >100MB, <1KB, or wrong MIME/extension
  - Upload progress is tracked via XMLHttpRequest
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire upload into record page and add processing state to transcript detail</name>
  <files>app/(app)/record/page.tsx, app/(app)/transcripts/[id]/page.tsx</files>
  <action>
  **Update `app/(app)/record/page.tsx`:**

  1. Add state for active tab: `const [activeTab, setActiveTab] = useState<"microphone" | "upload">("microphone")`
  2. Import `FileUpload` from `@/app/components/audio/file-upload`
  3. Add `useState` to the React import
  4. Make the existing "Microphone" and "Upload File" tab buttons functional:
     - Click Microphone button: `setActiveTab("microphone")`
     - Click Upload File button: `setActiveTab("upload")`
     - Active tab: burnt sienna background (#D4622B), white text (current "Microphone" styling)
     - Inactive tab: white background, muted text (#8B7E74), 1px border (#EDE6DD) (current "Upload File" styling)
  5. Conditionally render content based on activeTab:
     - `"microphone"`: Show existing waveform, timer, controls, live transcript (the current content)
     - `"upload"`: Show `<FileUpload />` component centered in the available space, with appropriate padding

  **Update `app/(app)/transcripts/[id]/page.tsx`:**

  1. Add a new condition block for `transcript.status === "processing"` BEFORE the "recording" status check (or after — just needs to be handled). This should show:
     - Back to Transcripts link (same as other status pages)
     - Title of the transcript
     - A centered card with:
       - Spinning circle indicator (32x32px, 3px border, cream border color #EDE6DD, burnt sienna border-top-color #D4622B, border-radius 50%, CSS animate-spin)
       - "Transcribing your file..." text (14px, weight 500, color #8B7E74)
       - "This usually takes a few seconds" subtext (12px, color #B5A99A)
     - Because this page uses `useQuery`, Convex will automatically re-render when the transcript status changes from "processing" to "completed", seamlessly transitioning to the full transcript view.

  2. Add handling for `transcript.status === "error"`:
     - Back to Transcripts link
     - A centered card showing error icon, "Transcription Failed" title, the error message from `transcript.errorMessage` (if available, or generic "Something went wrong"), and a "Delete" button that calls deleteTranscript and navigates to /transcripts.
  </action>
  <verify>
  1. `npx tsc --noEmit` passes without errors
  2. Run `npm run dev` and verify:
     - Record page shows two tabs: Microphone (default active) and Upload File
     - Clicking "Upload File" tab shows the file upload area
     - Clicking "Microphone" tab returns to recording interface
     - Both tabs toggle visual active/inactive states
  </verify>
  <done>
  - Record page has functional Microphone/Upload File tab switcher
  - Upload File tab renders the FileUpload component
  - Transcript detail page handles "processing" status with spinner
  - Transcript detail page handles "error" status with error message and delete button
  - Convex reactivity auto-updates transcript detail page when transcription completes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete file upload flow: select audio file, see upload progress, navigate to transcript detail showing processing spinner, then see completed transcript with speaker labels and timestamps.</what-built>
  <how-to-verify>
  1. Open the app at http://localhost:3000 and log in
  2. Navigate to Record page
  3. Click "Upload File" tab — verify it shows the upload area with supported formats
  4. Click "Microphone" tab — verify recording interface appears
  5. Click "Upload File" tab again
  6. Click "Select Audio File" and choose an MP3 or WAV file
  7. Verify you see upload progress (percentage bar filling up)
  8. Verify you are navigated to the transcript detail page
  9. Verify you see "Transcribing your file..." with a spinner
  10. Wait a few seconds — verify the transcript appears with speaker labels and timestamps
  11. Verify the uploaded transcript appears in the transcripts list alongside any live recordings
  12. Test error case: try uploading a .txt file or a file >100MB — verify you see a clear error message
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. File upload flow works end-to-end: select file -> upload with progress -> transcription -> view transcript
2. Client-side validation catches bad files before upload
3. Processing state is visible in transcript detail page during transcription
4. Error state is handled gracefully in both upload UI and transcript detail
5. Existing recording flow remains unchanged
6. Tab switching between Microphone and Upload File works correctly
</verification>

<success_criteria>
- User can upload an audio file and see it transcribed with speaker diarization and timestamps
- Upload progress is visible during file transfer
- Error messages are clear for wrong formats and oversized files
- Uploaded transcripts appear in the same list as live recordings
- Processing spinner shows while Deepgram is transcribing
- Convex reactivity auto-transitions from processing to completed view
</success_criteria>

<output>
After completion, create `.planning/phases/02-file-upload-batch-processing/02-02-SUMMARY.md`
</output>
