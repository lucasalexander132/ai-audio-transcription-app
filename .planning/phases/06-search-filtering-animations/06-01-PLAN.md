---
phase: 06-search-filtering-animations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/lib/motion/features.ts
  - app/components/library/animated-card-list.tsx
  - app/(app)/transcripts/page.tsx
autonomous: false

must_haves:
  truths:
    - "When the user types a search query, cards that no longer match fade out and scale down rather than disappearing instantly"
    - "Cards that remain in the filtered results smoothly reposition to close gaps left by removed cards (layout animation)"
    - "When clearing the search, returning cards animate in with a fade and scale up"
    - "On initial page load, transcript cards appear with a brief staggered entrance animation"
    - "Empty state fades in/out smoothly when results narrow to zero or return from zero"
  artifacts:
    - path: "app/lib/motion/features.ts"
      provides: "domMax feature set for layout animations"
      contains: "domMax"
    - path: "app/components/library/animated-card-list.tsx"
      provides: "AnimatePresence + layout + staggered entrance wrapper for transcript cards"
      exports: ["AnimatedCardList"]
    - path: "app/(app)/transcripts/page.tsx"
      provides: "Transcripts page using AnimatedCardList instead of plain div.map()"
      contains: "AnimatedCardList"
  key_links:
    - from: "app/(app)/transcripts/page.tsx"
      to: "app/components/library/animated-card-list.tsx"
      via: "import and render AnimatedCardList"
      pattern: "AnimatedCardList"
    - from: "app/components/library/animated-card-list.tsx"
      to: "app/components/library/transcript-card.tsx"
      via: "renders TranscriptCard inside m.div wrappers"
      pattern: "TranscriptCard"
    - from: "app/components/library/animated-card-list.tsx"
      to: "motion/react"
      via: "AnimatePresence and m.div with layout prop"
      pattern: "AnimatePresence.*layout"
    - from: "app/lib/motion/features.ts"
      to: "motion/react"
      via: "exports domMax for LazyMotion"
      pattern: "domMax"
---

<objective>
Add animated enter/exit/reposition transitions to transcript cards in the library list during search filtering, plus a staggered entrance animation on initial page load.

Purpose: Transform the instant-swap card filtering into smooth, premium-feeling animations that match a well-built native app. This is the core visual enhancement for MICRO-03.

Output: Three files -- upgraded motion feature loader, new AnimatedCardList component, and updated transcripts page integrating the animated list.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-foundation-search-flash-fix/05-02-SUMMARY.md
@.planning/phases/06-search-filtering-animations/06-RESEARCH.md
@app/lib/motion/features.ts
@app/components/library/transcript-card.tsx
@app/(app)/transcripts/page.tsx
@app/components/providers/motion-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade LazyMotion features from domAnimation to domMax</name>
  <files>app/lib/motion/features.ts</files>
  <action>
Change the single import in `app/lib/motion/features.ts` from `domAnimation` to `domMax`:

```typescript
"use client";

import { domMax } from "motion/react";  // Changed from domAnimation
export default domMax;
```

This is a one-line change. The `domMax` feature set includes everything `domAnimation` has plus layout animations (HTMLProjectionNode + MeasureLayout) and drag. The layout feature is required for the `layout` prop on `m.div` to work -- without it, cards will snap to new positions instead of animating.

The async chunk size increases from ~6kb to ~16kb. This is acceptable because layout animations are the core of this phase's functionality.

**Important:** Do NOT change anything else in this file. Do NOT modify `motion-provider.tsx` -- it already loads features from this file via dynamic import.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors.
Run `npm run build` and verify the build succeeds. The terminal output should show the motion chunk loading successfully.
  </verify>
  <done>
`features.ts` exports `domMax` instead of `domAnimation`. Build passes. All existing animations (if any) still work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AnimatedCardList and integrate into transcripts page</name>
  <files>app/components/library/animated-card-list.tsx, app/(app)/transcripts/page.tsx</files>
  <action>
**Part A: Create `app/components/library/animated-card-list.tsx`**

Create a new client component that wraps transcript cards with Motion animation capabilities. This component handles three animation concerns:

1. **Staggered entrance on initial load:** Cards cascade in one-by-one when the page first mounts. Use per-item `transition.delay` with `Math.min(index, STAGGER_CAP) * 0.05` to cap at 8 items (total stagger ~400ms max). Track initial load with a `useRef` that flips to `false` after first render.

2. **Enter/exit animations during search filtering:** Cards that are removed fade out and scale down (opacity 0, scale 0.96, 150ms, ease-in). Cards that appear fade in and scale up (opacity 0 -> 1, scale 0.96 -> 1, 200ms, ease-out). Use `AnimatePresence` with `mode="popLayout"` so exiting cards are immediately removed from document flow and remaining cards reposition to close gaps.

3. **Layout repositioning:** Add `layout` prop to each card's `m.div` wrapper so that when siblings are added/removed, remaining cards smoothly animate to their new positions using Motion's FLIP technique (transform-based, GPU-composited).

Key implementation details:

- Use `m.div` from `"motion/react-m"` (NOT `motion.div`) due to LazyMotion strict mode.
- Import `AnimatePresence` from `"motion/react"` (it's a standalone component, not part of the m namespace).
- The outer container `m.div` should have `style={{ position: "relative" }}` because `popLayout` mode uses absolute positioning for exiting elements.
- Use `className="flex flex-col"` and `style={{ gap: 12, padding: "0 24px", paddingBottom: 120 }}` to match the current card list styling exactly.
- Each card's `m.div` wrapper uses `key={transcript._id}` (Convex document ID) for stable identity.
- Set `initial={false}` on `AnimatePresence` so cards already in the list when search filter changes do NOT re-run their enter animation -- only newly appearing cards animate in.

The component props interface should accept:
- `transcripts`: The `displayTranscripts` array from the page
- `tagsByTranscript`: Map of transcript ID to tag names
- `speakersByTranscript`: Map of transcript ID to speaker labels
- `onCardClick`: Callback with transcript ID string

Use the `TranscriptCard` component's existing props interface. Import `TranscriptCard` from `"./transcript-card"`.

For the stagger cap pattern, use a `useRef(true)` for `isInitialLoad` and set it to `false` in a `useEffect` that runs once. Only apply stagger delays when `isInitialLoad.current` is `true`. After the initial render, all subsequent enter/exit animations use the standard 200ms/150ms durations without stagger delay.

Animation values (these create the "standard premium feel"):
- **Enter:** opacity 0 -> 1, scale 0.96 -> 1, y 8 -> 0, duration 200ms, ease "easeOut"
- **Exit:** opacity 1 -> 0, scale 1 -> 0.96, duration 150ms, ease "easeIn"
- **Layout reposition:** duration 200ms, ease [0.25, 0.1, 0.25, 1] (CSS ease equivalent)
- **Stagger:** 50ms per card, 100ms start delay, capped at 8 cards (max 500ms total)

**Part B: Update `app/(app)/transcripts/page.tsx`**

Replace the plain card list rendering with the new `AnimatedCardList` component. Also wrap the loading/empty/list states in `AnimatePresence` for smooth crossfades.

Specific changes:

1. Add import: `import { AnimatedCardList } from "@/app/components/library/animated-card-list";`
2. Add imports for animation: `import { AnimatePresence } from "motion/react";` and `import { m } from "motion/react-m";`

3. Replace the content section (currently lines ~244-280) which has the loading/empty/list ternary. Wrap it in `AnimatePresence mode="wait"` to crossfade between states:

```tsx
<AnimatePresence mode="wait">
  {isLoading ? (
    <m.div
      key="skeleton"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{ duration: 0.15 }}
    >
      {/* existing skeleton code unchanged */}
    </m.div>
  ) : displayTranscripts.length === 0 ? (
    <m.div
      key="empty"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{ duration: 0.2 }}
    >
      <EmptyState type={isSearchActive ? "search" : activeTab} />
    </m.div>
  ) : (
    <m.div
      key="list"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{ duration: 0.15 }}
    >
      <AnimatedCardList
        transcripts={displayTranscripts}
        tagsByTranscript={tagsByTranscript}
        speakersByTranscript={speakersByTranscript}
        onCardClick={(id) => router.push(`/transcripts/${id}`)}
      />
    </m.div>
  )}
</AnimatePresence>
```

4. Remove the now-unused direct `TranscriptCard` import if it's no longer referenced in this file (it's now imported inside `AnimatedCardList` instead). Keep it only if it's still used elsewhere in the file.

**Important considerations:**
- Do NOT change the `EmptyState` component at all -- just wrap it in `m.div` for the crossfade.
- Do NOT modify the search logic, tab filtering, or any data fetching -- those are Phase 05 work and should not be touched.
- Do NOT change `transcript-card.tsx` -- the card itself stays the same, only its wrapper gets animation.
- All animated properties (opacity, scale, transform/y) are GPU-composited, safe for iOS PWA 30-40fps.
- Keep animation durations under 250ms (well under the 300ms debounce window) to prevent animation artifacts from rapid typing.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- no TypeScript errors.
2. Run `npm run build` -- build succeeds with no errors.
3. Verify `animated-card-list.tsx` exists and exports `AnimatedCardList`.
4. Verify `page.tsx` imports and renders `AnimatedCardList`.
5. Verify `page.tsx` no longer has a plain `div.map()` over `displayTranscripts` for rendering cards.
  </verify>
  <done>
New `animated-card-list.tsx` component wraps TranscriptCard items in `m.div` wrappers with AnimatePresence (popLayout mode), layout prop, and staggered entrance. The transcripts page uses AnimatedCardList and wraps loading/empty/list states in AnimatePresence for crossfade transitions. TypeScript and build both pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Animated search filtering for transcript cards with four animation behaviors:
1. Cards fade out + scale down when filtered out by search
2. Remaining cards smoothly reposition to close gaps
3. Cards fade in + scale up when returning (clearing search)
4. Staggered cascade entrance on initial page load
Plus crossfade transitions between loading skeleton, empty state, and card list.
  </what-built>
  <how-to-verify>
1. Open the app in browser: `http://localhost:3000/transcripts` (ensure dev server is running with `npm run dev`)
2. **Initial load stagger:** Refresh the page. Transcript cards should cascade in one-by-one with a subtle stagger (each card fades in and slides up slightly, ~50ms apart, capped at 8 cards).
3. **Search exit animation:** Click the search icon, type a query that filters out some cards. Cards that no longer match should fade out and scale down smoothly (not disappear instantly). Remaining cards should slide up to close the gaps left behind.
4. **Search enter animation:** Clear the search input. Returning cards should fade in and scale up smoothly.
5. **Empty state crossfade:** Type a query that matches nothing. The empty state ("No results") should fade in smoothly. Clear the search -- the card list should fade back in.
6. **Rapid typing:** Type and delete characters quickly. Animations should not produce artifacts (stuck cards, flickering, overlapping elements).
7. **Reduced motion:** Enable "Reduce Motion" in OS settings (macOS: System Settings > Accessibility > Display > Reduce Motion). Reload the page -- all animations should be disabled (cards appear/disappear instantly).
8. **iOS PWA (if device available):** Open on an iPhone home screen app. Animations should feel smooth, not janky (all animations use GPU-composited properties).
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 06, or describe specific issues with animation timing, behavior, or visual quality.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` succeeds
3. `app/lib/motion/features.ts` exports `domMax` (not `domAnimation`)
4. `app/components/library/animated-card-list.tsx` exists and exports `AnimatedCardList`
5. `app/(app)/transcripts/page.tsx` uses `AnimatedCardList` component
6. `app/(app)/transcripts/page.tsx` wraps content states in `AnimatePresence mode="wait"`
7. No `motion.div` usage anywhere (must use `m.div` for LazyMotion strict mode)
8. All animation durations are under 250ms
9. All animated properties are GPU-composited (opacity, scale, transform only)
</verification>

<success_criteria>
- Transcript cards animate smoothly during search filtering (fade + scale + layout reposition)
- Initial page load shows staggered card entrance (capped at 8 cards, ~400ms total)
- Empty state crossfades in/out when results change between zero and non-zero
- Animations feel "standard premium" -- polished and expected, not experimental
- TypeScript and build both pass
- Reduced motion preference is respected (via existing MotionConfig)
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-filtering-animations/06-01-SUMMARY.md`
</output>
