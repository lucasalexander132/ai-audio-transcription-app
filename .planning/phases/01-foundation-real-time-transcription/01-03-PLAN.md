---
phase: 01-foundation-real-time-transcription
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/(app)/transcripts/[id]/page.tsx
  - app/components/audio/audio-player.tsx
  - app/components/audio/transcript-view.tsx
  - app/components/audio/speaker-label-editor.tsx
autonomous: false

must_haves:
  truths:
    - "User can view a completed transcript with speaker-attributed text and timestamps"
    - "User can play back recorded audio with seek bar"
    - "User can change playback speed (1x, 1.5x, 2x)"
    - "User can rename speaker labels (Speaker 1 -> Sarah Chen)"
    - "Renamed labels persist and show throughout transcript"
  artifacts:
    - path: "app/(app)/transcripts/[id]/page.tsx"
      provides: "Transcript detail page"
      min_lines: 40
    - path: "app/components/audio/audio-player.tsx"
      provides: "Audio playback with seek and speed controls"
      min_lines: 50
    - path: "app/components/audio/transcript-view.tsx"
      provides: "Full transcript display grouped by speaker with timestamps"
      min_lines: 60
    - path: "app/components/audio/speaker-label-editor.tsx"
      provides: "Inline speaker label rename UI"
      min_lines: 30
  key_links:
    - from: "app/components/audio/audio-player.tsx"
      to: "convex/recordings.ts"
      via: "Fetches audio URL for playback"
      pattern: "useQuery.*getRecordingUrl"
    - from: "app/components/audio/transcript-view.tsx"
      to: "convex/transcripts.ts"
      via: "Subscribes to words and speaker labels"
      pattern: "useQuery.*(getWords|getSpeakerLabels)"
    - from: "app/components/audio/speaker-label-editor.tsx"
      to: "convex/transcripts.ts"
      via: "Calls updateSpeakerLabel mutation"
      pattern: "useMutation.*updateSpeakerLabel"
    - from: "app/(app)/transcripts/[id]/page.tsx"
      to: "app/components/audio/*"
      via: "Composes transcript view"
      pattern: "AudioPlayer|TranscriptView|SpeakerLabelEditor"
---

<objective>
Build the transcript detail view with audio playback (seek + speed controls) and speaker label renaming. This completes the core user journey: record -> transcribe -> review -> rename speakers.

Purpose: Users need to review transcripts after recording, play back audio to verify accuracy, and rename generic speaker labels to real names. This is the "payoff" screen â€” where the transcription value is consumed.
Output: Transcript detail page with grouped speaker text, timestamps, audio player with speed controls, and inline speaker label editing.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-real-time-transcription/01-RESEARCH.md
@.planning/phases/01-foundation-real-time-transcription/01-01-SUMMARY.md
@.planning/phases/01-foundation-real-time-transcription/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transcript detail page with audio player, transcript view, and speaker rename</name>
  <files>
    app/(app)/transcripts/[id]/page.tsx
    app/components/audio/audio-player.tsx
    app/components/audio/transcript-view.tsx
    app/components/audio/speaker-label-editor.tsx
  </files>
  <action>
    1. Create audio player component (`app/components/audio/audio-player.tsx`):
       - Accept audioUrl prop (from Convex storage URL)
       - Use HTML5 <audio> element with ref
       - Play/pause toggle button (large, centered, thumb-friendly)
       - Seek bar: range input showing current position / total duration
         - Display current time and total duration as MM:SS
         - User can drag to seek
         - onTimeUpdate updates position every 250ms
       - Speed controls: 3 buttons for 1x, 1.5x, 2x
         - Active speed highlighted with primary color (burnt sienna)
         - Changes audio.playbackRate on click
       - Layout: compact horizontal bar at top of transcript view
         - Play button | seek bar with times | speed buttons
       - Handle loading state (audio not yet loaded)
       - Handle missing audio gracefully (show "Audio unavailable" message)
       - Style: Tailwind mobile-first, rounded controls, warm color palette

    2. Create transcript view component (`app/components/audio/transcript-view.tsx`):
       - Accept transcriptId prop
       - Subscribe to words via useQuery(api.transcripts.getWords, { transcriptId })
       - Subscribe to speaker labels via useQuery(api.transcripts.getSpeakerLabels, { transcriptId })
       - Group words into speaker segments: consecutive words with same speaker number form a segment
       - Each segment displays:
         a. Speaker label: use custom label from speakerLabels if exists, otherwise "Speaker {N}"
            - Color dot next to speaker name (consistent color per speaker number: use predefined palette)
            - Speaker label is clickable (opens SpeakerLabelEditor)
         b. Timestamp: format first word's startTime as MM:SS, displayed in muted text
         c. Text: all words in segment joined with spaces, normal text size
       - Segments separated by small vertical gap
       - Scrollable container (full remaining viewport height)
       - Empty state: "No transcript yet" with muted text
       - Use React.memo on individual segment components for performance
       - Loading state: skeleton shimmer lines

    3. Create speaker label editor (`app/components/audio/speaker-label-editor.tsx`):
       - Inline editing: when user clicks a speaker label, it becomes an editable text input
       - Input is pre-filled with current label (custom or "Speaker N")
       - On Enter or blur: save via useMutation(api.transcripts.updateSpeakerLabel) with transcriptId, speakerNumber, and new label
       - On Escape: cancel editing, revert to original
       - Visual: input has bottom border (underline style), same font size as label, minimal UI disruption
       - Show a small edit icon (pencil) next to speaker labels on hover/focus (or always on mobile)
       - Validation: label must be non-empty, max 50 characters
       - After save: all instances of that speaker label update throughout the transcript (because they all read from the same speakerLabels query)

    4. Create transcript detail page (`app/(app)/transcripts/[id]/page.tsx`):
       - Dynamic route: extract transcript ID from params
       - Fetch transcript metadata via useQuery(api.transcripts.get, { id })
       - Fetch recording URL via useQuery(api.recordings.getRecordingUrl, { transcriptId: id })
       - Layout (top to bottom):
         a. Back button (arrow left) -> navigates to /transcripts
         b. Transcript title (or "Recording - {date}" if no title)
         c. Transcript metadata: duration (MM:SS), date, number of speakers
         d. Audio player component (if recording exists)
         e. Transcript view component (scrollable, takes remaining space)
       - Handle cases:
         - Transcript not found: show "Transcript not found" with back link
         - Still recording (status === "recording"): redirect to /record or show "Recording in progress"
         - No audio yet: hide audio player, show transcript only
       - Mobile-first layout with safe area padding
  </action>
  <verify>
    - `npm run dev` and complete a recording (from Plan 02)
    - After stopping recording, navigate to transcript detail page
    - Audio player shows and can play back the recording
    - Speed controls (1x, 1.5x, 2x) change playback speed
    - Seek bar allows jumping to different positions
    - Transcript shows speaker-labeled segments with timestamps
    - Clicking a speaker label opens inline editor
    - Renaming a speaker updates all instances of that label
    - `npm run build` succeeds
  </verify>
  <done>
    - Transcript detail page displays full speaker-attributed transcript with timestamps
    - Audio player plays back recording with functional seek bar
    - Speed controls change playback rate (1x, 1.5x, 2x)
    - Speaker labels are clickable and renamable inline
    - Renamed labels persist in database and update across all segments
    - Mobile-friendly layout with proper spacing and touch targets
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 1 flow on device</name>
  <what-built>
    Complete Phase 1: authentication, PWA manifest, FAB navigation, audio recording with live transcription, transcript playback with speed controls, and speaker label renaming.
  </what-built>
  <how-to-verify>
    Run `npm run dev` and test the complete flow:

    1. **Auth flow:**
       - Visit localhost:3000 -> should redirect to /login
       - Create a new account (signup page)
       - Verify you're redirected to /record after signup
       - Refresh browser -> should stay logged in (session persistence)

    2. **Navigation:**
       - Tap the FAB button (bottom-right) -> menu expands with Record, Transcripts, Settings
       - Navigate to each page via FAB
       - Settings page has working sign-out button

    3. **Recording + Transcription:**
       - Go to /record -> tap Record button
       - Grant microphone permission when prompted
       - Speak clearly -> verify waveform visualizer responds to voice
       - Verify timer counts up (MM:SS)
       - Verify real-time transcription text appears as you speak
       - Verify speaker labels show (Speaker 1, etc.)
       - Pause recording -> verify timer stops, waveform stops
       - Resume -> verify everything continues
       - Stop recording -> verify it navigates to transcript detail

    4. **Transcript View + Playback:**
       - On transcript detail page: verify audio player appears
       - Play audio -> verify recorded audio plays back
       - Test seek bar (drag to different position)
       - Test speed controls: 1x, 1.5x, 2x (audio speed changes)
       - Verify transcript shows speaker-labeled text with timestamps

    5. **Speaker Rename:**
       - Click on a speaker label (e.g., "Speaker 1")
       - Type a new name (e.g., "Sarah Chen")
       - Press Enter -> verify all instances of Speaker 1 update to "Sarah Chen"

    6. **PWA:**
       - Open Chrome DevTools -> Application -> Manifest
       - Verify manifest loads with correct app name and icons
       - (Optional) On mobile: verify "Add to Home Screen" prompt appears

    **Expected issues to flag:**
    - Any step that fails or behaves unexpectedly
    - Transcription accuracy concerns
    - UI layout problems on mobile
    - Performance issues (slow transcription, choppy waveform)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 1, or describe any issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
1. Complete end-to-end flow works: signup -> record -> see transcription -> stop -> view transcript -> play audio -> rename speakers
2. Auth persists across browser refresh
3. FAB navigation works between all pages
4. Audio playback with seek and speed controls functions correctly
5. Speaker rename updates all instances throughout transcript
6. PWA manifest is valid and app is installable
7. Mobile layout is usable (no horizontal scroll, touch-friendly controls)
</verification>

<success_criteria>
- TRX-03: User can rename speaker labels (Speaker 1 -> custom name) with persistence
- TRX-04: User can play back recorded audio with seek bar and speed controls (1x, 1.5x, 2x)
- TRX-05: Timestamps shown alongside speaker text in transcript view
- All Phase 1 success criteria verified by human (checkpoint)
- Complete user journey works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-real-time-transcription/01-03-SUMMARY.md`
</output>
