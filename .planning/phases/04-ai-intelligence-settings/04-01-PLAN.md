---
phase: 04-ai-intelligence-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/ai.ts
  - convex/userSettings.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "AI summary generation via Claude API"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key (https://console.anthropic.com/settings/keys)"
    dashboard_config: []

must_haves:
  truths:
    - "User can generate an AI summary that persists across page refresh"
    - "User settings (language, punctuation) survive page refresh with correct values"
    - "AI summary displays overview paragraph, key points list, and action items section"
    - "Default settings are English language and auto-punctuation on for new users"
    - "Generating a summary twice for the same transcript is prevented"
  artifacts:
    - path: "convex/schema.ts"
      provides: "aiSummaries and userSettings table definitions"
      contains: "aiSummaries"
    - path: "convex/ai.ts"
      provides: "generateSummary action, getSummary query, internal storeSummary mutation"
      exports: ["generateSummary", "getSummary"]
    - path: "convex/userSettings.ts"
      provides: "getUserSettings query, upsertSettings mutation"
      exports: ["getUserSettings", "upsertSettings"]
  key_links:
    - from: "convex/ai.ts"
      to: "Claude Messages API"
      via: "fetch in generateSummary action"
      pattern: "api\\.anthropic\\.com/v1/messages"
    - from: "convex/ai.ts"
      to: "convex/schema.ts"
      via: "storeSummary internal mutation inserts into aiSummaries"
      pattern: "ctx\\.db\\.insert.*aiSummaries"
    - from: "convex/userSettings.ts"
      to: "convex/schema.ts"
      via: "query/mutation against userSettings table"
      pattern: "userSettings"
---

<objective>
Add backend schema and Convex functions for AI summaries and user settings.

Purpose: This is the data foundation for Phase 4. The AI summary action calls Claude's API to generate structured summaries (overview, key points, action items) from transcript text. The user settings functions persist language and punctuation preferences.

Output: Two new Convex tables (aiSummaries, userSettings), a Claude API action, a summary query, and settings CRUD functions.
</objective>

<execution_context>
@/Users/lucasalexander/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucasalexander/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-intelligence-settings/04-RESEARCH.md
@.planning/phases/04-ai-intelligence-settings/04-CONTEXT.md
@convex/schema.ts
@convex/deepgram.ts
@convex/transcripts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extensions + user settings functions</name>
  <files>convex/schema.ts, convex/userSettings.ts</files>
  <action>
    Add two new tables to convex/schema.ts:

    1. `aiSummaries` table:
       - transcriptId: v.id("transcripts")
       - userId: v.id("users")
       - overview: v.string()
       - keyPoints: v.array(v.string())
       - actionItems: v.array(v.object({ text: v.string(), assignee: v.string() }))
       - generatedAt: v.number()
       - model: v.string()
       - Index: "by_transcript" on ["transcriptId"]

    2. `userSettings` table:
       - userId: v.id("users")
       - transcriptionLanguage: v.optional(v.string())
       - autoPunctuation: v.optional(v.boolean())
       - Index: "by_userId" on ["userId"]

    Create convex/userSettings.ts with:

    1. `getUserSettings` query:
       - Auth check (return defaults if not authenticated)
       - Query userSettings by userId
       - If no document found, return { transcriptionLanguage: "en", autoPunctuation: true }
       - If found, return with defaults for any missing optional fields (transcriptionLanguage defaults to "en", autoPunctuation defaults to true)

    2. `upsertSettings` mutation:
       - Auth check
       - Args: { transcriptionLanguage: v.optional(v.string()), autoPunctuation: v.optional(v.boolean()) }
       - Query existing settings by userId
       - If exists: patch with provided args
       - If not: insert new document with userId + provided args
  </action>
  <verify>Run `npx convex dev --once` (or check that Convex syncs without errors). Verify schema.ts has both new tables, userSettings.ts exports getUserSettings and upsertSettings.</verify>
  <done>Schema has aiSummaries and userSettings tables with correct fields and indexes. getUserSettings returns sensible defaults. upsertSettings creates or updates settings document.</done>
</task>

<task type="auto">
  <name>Task 2: AI summary generation action + query</name>
  <files>convex/ai.ts</files>
  <action>
    Create convex/ai.ts with:

    1. `generateSummary` action:
       - Args: { transcriptId: v.id("transcripts") }
       - Auth check: get userId, verify transcript belongs to user
       - Check if summary already exists for this transcript (query aiSummaries by_transcript). If exists, throw error "Summary already generated for this transcript" to prevent double-generation
       - Load transcript's words via internal query or ctx.runQuery to get words sorted by startTime
       - Load speaker labels for this transcript
       - Build speaker-annotated text: group consecutive words by speaker, format as "Speaker 1: text\nSpeaker 2: text\n..." using speaker labels when available (fall back to "Speaker N" format)
       - Call Claude API via fetch (matching existing Deepgram pattern in deepgram.ts):
         ```
         POST https://api.anthropic.com/v1/messages
         Headers:
           x-api-key: process.env.ANTHROPIC_API_KEY
           anthropic-version: 2023-06-01
           content-type: application/json
         Body:
           model: "claude-haiku-4-5"
           max_tokens: 4096
           messages: [{ role: "user", content: prompt }]
         ```
       - The prompt should instruct Claude to analyze the transcript and respond with JSON containing:
         - overview: 4-6 sentence summary covering main topics, decisions, outcomes
         - key_points: array of key discussion points (scale with content length)
         - action_items: array of { text, assignee } where assignee is speaker name or "Unassigned"
       - IMPORTANT: Do NOT use output_config.format (structured outputs). Instead, instruct Claude in the prompt to respond ONLY with valid JSON, no markdown fences. Then JSON.parse the response text content. This is simpler and haiku follows instructions well.
       - Parse the JSON response. If parsing fails, throw a descriptive error.
       - Store result via ctx.runMutation to internal storeSummary mutation
       - Return the stored summary data

    2. `storeSummary` internalMutation:
       - Args matching aiSummaries schema fields
       - Insert into aiSummaries table

    3. `getSummary` query:
       - Args: { transcriptId: v.id("transcripts") }
       - Auth check
       - Verify transcript belongs to user
       - Query aiSummaries by_transcript index
       - Return first result or null

    Use `import { action, query, internalMutation } from "./_generated/server"` and `import { internal } from "./_generated/api"` matching existing patterns in deepgram.ts.

    For reading words and speaker labels from within the action, use ctx.runQuery referencing the existing exported queries (api.transcripts.getWords, api.transcripts.getSpeakerLabels). Import `import { api } from "./_generated/api"` for this.
  </action>
  <verify>Run `npx convex dev --once` to verify ai.ts compiles and deploys. Check that generateSummary, getSummary are exported. Verify the Claude API prompt includes speaker-annotated text and requests JSON output.</verify>
  <done>generateSummary action calls Claude API with speaker-annotated transcript, parses structured JSON response, stores in aiSummaries. getSummary query returns existing summary or null. Double-generation is prevented.</done>
</task>

</tasks>

<verification>
- `npx convex dev --once` completes without errors
- convex/schema.ts contains aiSummaries and userSettings table definitions
- convex/ai.ts exports generateSummary (action) and getSummary (query)
- convex/userSettings.ts exports getUserSettings (query) and upsertSettings (mutation)
- No new npm packages installed (all via fetch)
</verification>

<success_criteria>
- Two new tables in schema with correct indexes
- AI action builds speaker-annotated text and calls Claude haiku API
- Summary stored with overview, keyPoints, actionItems
- Settings query returns defaults, mutation does upsert
- All Convex functions deploy successfully
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-intelligence-settings/04-01-SUMMARY.md`
</output>
